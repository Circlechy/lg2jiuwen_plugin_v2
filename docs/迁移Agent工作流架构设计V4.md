# 迁移 Agent 工作流架构设计 V4

> 版本：V4
> 更新日期：2026-01-24

## 一、架构概述

LG2Jiuwen 迁移工具采用 **openJiuwen 框架自身实现**，遵循"**规则优先，AI 兜底**"的设计原则。

### 核心设计理念

```
规则能处理的用规则（快速、确定、低成本）
规则无法处理的用 AI（语义理解、灵活）
```

### 整体架构流程

```
源代码 → AST → RuleExtractor(转换) → [AISemantic(转换剩余)] → IR(已转换代码) → CodeGenerator(模板填充)
```

---

## 二、工作流架构图

```
                    ┌─────────────────────────────────────────────────────────────┐
                    │                      迁移工作流                               │
                    └─────────────────────────────────────────────────────────────┘
                                                │
                                                ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│  Start                                                                                │
│  inputs: source_path, output_dir                                                     │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                                │
                                                ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│  ProjectDetectorComp (项目检测)                                                       │
│  - 判断单文件/多文件项目                                                              │
│  - 分析依赖顺序                                                                       │
│  outputs: file_list, dependency_order, is_multi_file, project_root                  │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                                │
                                                ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│  FileLoaderComp (文件加载)                                                            │
│  - 读取源文件内容                                                                     │
│  outputs: file_contents, dependency_order                                            │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                                │
                                                ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│  ASTParserComp (AST 解析)                                                             │
│  - 解析 Python 源代码为 AST                                                           │
│  outputs: ast_map, dependency_order                                                  │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                                │
                                                ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│  RuleExtractorComp (规则提取) ★ 核心组件                                              │
│  - 提取 LangGraph 结构（状态、节点、边、工具、LLM配置）                                │
│  - 应用转换规则（状态访问、LLM调用、工具调用、返回语句）                                │
│  - 生成待处理项（规则无法处理的代码）                                                  │
│  outputs: extraction_result                                                          │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                                │
                                                ▼
┌──────────────────────────────────────────────────────────────────────────────────────┐
│  PendingCheckComp (待处理检查)                                                        │
│  - 检查是否有待处理项                                                                 │
│  outputs: extraction_result, has_pending                                             │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                                │
                                ┌───────────────┴───────────────┐
                                │      pending_router           │
                                │   has_pending?                │
                                └───────────────┬───────────────┘
                        ┌───────────────────────┼───────────────────────┐
                        │ Yes                   │                    No │
                        ▼                       │                       ▼
┌───────────────────────────────────┐           │    ┌───────────────────────────────────┐
│  AISemanticComp (AI 语义理解)      │           │    │  IRBuilderComp (直接路径)          │
│  - 处理规则无法转换的代码          │           │    │                                    │
│  outputs: extraction_result       │           │    │                                    │
└───────────────────────────────────┘           │    └───────────────────────────────────┘
                        │                       │                       │
                        ▼                       │                       ▼
┌───────────────────────────────────┐           │    ┌───────────────────────────────────┐
│  IRBuilderComp (IR 构建)           │           │    │  CodeGeneratorComp (直接路径)      │
│  - 将 ExtractionResult 转换为 IR  │           │    │                                    │
│  outputs: agent_ir, workflow_ir   │           │    │                                    │
└───────────────────────────────────┘           │    └───────────────────────────────────┘
                        │                       │                       │
                        ▼                       │                       ▼
┌───────────────────────────────────┐           │    ┌───────────────────────────────────┐
│  CodeGeneratorComp (代码生成)      │           │    │  ReportComp (直接路径)             │
│  - 根据 IR 生成 openJiuwen 代码   │           │    │                                    │
│  outputs: generated_files         │           │    │                                    │
└───────────────────────────────────┘           │    └───────────────────────────────────┘
                        │                       │                       │
                        ▼                       │                       ▼
┌───────────────────────────────────┐           │    ┌───────────────────────────────────┐
│  ReportComp (报告生成)             │           │    │  End (直接路径)                    │
│  - 生成迁移报告                    │           │    │                                    │
│  outputs: report, generated_files │           │    │                                    │
└───────────────────────────────────┘           │    └───────────────────────────────────┘
                        │                       │
                        ▼                       │
┌───────────────────────────────────┐           │
│  End                               │           │
│  outputs: generated_files, report │           │
└───────────────────────────────────┘           │
```

---

## 三、组件清单

| 组件 | 类名 | 职责 |
|------|------|------|
| 项目检测 | `ProjectDetectorComp` | 检测项目结构，分析依赖 |
| 文件加载 | `FileLoaderComp` | 读取源文件内容 |
| AST 解析 | `ASTParserComp` | 解析 Python 代码为 AST |
| 规则提取 | `RuleExtractorComp` | 提取结构 + 应用转换规则 |
| 待处理检查 | `PendingCheckComp` | 检查是否需要 AI 处理 |
| AI 语义理解 | `AISemanticComp` | 处理规则无法转换的代码 |
| IR 构建 | `IRBuilderComp` | 将提取结果转换为 IR |
| 代码生成 | `CodeGeneratorComp` | 根据 IR 生成代码 |
| 报告生成 | `ReportComp` | 生成迁移报告 |

---

## 四、数据流

### 4.1 主要数据结构

```
ExtractionResult          →    AgentIR / WorkflowIR    →    生成的代码
(提取+转换结果)                 (中间表示)                   (最终输出)
```

### 4.2 数据传递方式

| 传递方式 | 语法 | 使用场景 |
|---------|------|---------|
| inputs_schema | `${node.field}` | 组件间显式传递 |
| inputs_transformer | 函数 | 复杂数据转换 |

---

## 五、生成的文件结构

```
{agent_name}/
├── __init__.py           # 模块入口
├── config.py             # 配置（LLM、全局变量）
├── tools.py              # 工具函数 + invoke_tool 辅助函数
├── components/
│   ├── __init__.py
│   └── {node}_comp.py    # 每个节点一个组件
├── routers.py            # 路由函数
├── workflow.py           # 工作流构建
└── main.py               # 主入口（含示例）
```

---

## 六、关键设计决策

1. **规则优先**：所有转换优先用规则处理，快速确定
2. **AI 兜底**：规则无法处理的代码交给 AI
3. **IR 中间表示**：解耦提取/转换与代码生成
4. **条件路由**：根据是否有待处理项选择路径
5. **多文件支持**：自动检测项目结构，生成对应目录

---

*由 LG2Jiuwen 迁移工具架构文档*
