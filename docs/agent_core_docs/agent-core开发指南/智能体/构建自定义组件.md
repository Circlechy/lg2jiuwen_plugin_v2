本章节演示了如何基于openJiuwen构建一个使用自定义组件的工作流样例，该样例支持通过用户输入，基于自定义分支组件选择不同的自定义组件分支，生成最终结果。通过本示例，你将会了解到如下信息：

* 如何创建自定义组件。
* 如何基于自定义组件创建工作流。

# 创建Workflow流程

创建Workflow的整体流程如下：首先通过`Workflow`初始化工作流，接着定义各组件并将组件注册到工作流，并设置组件间的连接，从而完成整个工作流的创建。本示例设计的Workflow如下：用户输入 → 意图识别 → 出行/就餐 → 返回结果。示例代码如下：

## 初始化工作流

初始化工作流：

```python
from openjiuwen.core.workflow.base import Workflow
# 创建工作流
flow = Workflow()
```

## 注册组件到工作流

根据任务需求创建核心组件实例，配置各组件的输入/输出规则，并将组件注册到工作流，实现流程的自动化与逻辑控制。本教程除了使用openJiuwen预置的开始与结束组件外，还自定义了分支组件和处理组件。

### 开始组件

通过`Start`创建开始组件对象，为工作流设置开始组件：

```python
from openjiuwen.core.component.start_comp import Start

flow.set_start_comp("start", Start(), inputs_schema={"query":"${user_inputs.query}"})
```

### 自定义分支组件

创建自定义分支组件`CustomIntentComponent`，同时继承`WorkflowComponent`和`ComponentExecutable`，实现add_component接口，用于为本组件定制内置的条件边，并自定义实现了接口`add_branch`用于绑定内置条件边的目标节点：

```python
import random

from openjiuwen.core.component.base import WorkflowComponent
from openjiuwen.core.component.branch_router import BranchRouter
from openjiuwen.core.context_engine.base import Context
from openjiuwen.core.graph.base import Graph
from openjiuwen.core.runtime.base import ComponentExecutable, Input, Output
from openjiuwen.core.runtime.runtime import Runtime


class CustomIntentComponent(WorkflowComponent, ComponentExecutable):
    def __init__(self, default_intents):
        super().__init__()
        self._intents = default_intents
        self._router = BranchRouter()

    def add_component(self, graph: Graph, node_id: str, wait_for_all: bool = False) -> None:
        graph.add_node(node_id, self.to_executable(), wait_for_all=wait_for_all)
        graph.add_conditional_edges(node_id, self._router)

    def add_branch(self, condition: str, target: list[str], branch_id:str):
        self._router.add_branch(condition=condition, target=target, branch_id=branch_id)

    async def invoke(self, inputs: Input, runtime: Runtime, context: Context) -> Output:
        self._router.set_runtime(runtime)
        return {'result': self._intents[random.randint(0, len(self._intents) - 1)]}
```

实例化自定义分支组件，分支包含`出行`和`餐饮`：

```python
intent_component = CustomIntentComponent(["出行", "餐饮"])
intent_component.add_branch(condition="${intent.result} == '出行'", target=['travel'], branch_id='1')
intent_component.add_branch(condition="${intent.result} == '餐饮'", target=['eat'], branch_id='2')
```

将自定义分支组件注册到工作流中：

```python
flow.add_workflow_comp("intent", intent_component, inputs_schema={"query": "${start.query}"})
```

### 自定义组件

创建自定义组件`TravelComponent`，用于`出行`分支：

```python
from openjiuwen.core.component.base import WorkflowComponent
from openjiuwen.core.context_engine.base import Context
from openjiuwen.core.runtime.base import ComponentExecutable, Input, Output
from openjiuwen.core.runtime.runtime import Runtime


class TravelComponent(WorkflowComponent, ComponentExecutable):
    def __init__(self, node_id):
        super().__init__()
        self.node_id = node_id

    async def invoke(self, inputs: Input, runtime: Runtime, context: Context) -> Output:
        print(f'[{self.node_id}] inputs = {inputs}')
        return inputs
```

创建自定义组件`EatComponent`，用于`餐饮`分支：

```python
from openjiuwen.core.component.base import WorkflowComponent
from openjiuwen.core.context_engine.base import Context
from openjiuwen.core.runtime.base import ComponentExecutable, Input, Output
from openjiuwen.core.runtime.runtime import Runtime


class EatComponent(WorkflowComponent, ComponentExecutable):
    def __init__(self, node_id):
        super().__init__()
        self.node_id = node_id

    async def invoke(self, inputs: Input, runtime: Runtime, context: Context) -> Output:
        print(f'[{self.node_id}] inputs = {inputs}')
        return inputs
```

将自定义组件`TravelComponent`和`EatComponent`注册到工作流中。

```python
flow.add_workflow_comp("eat", EatComponent("eat"), inputs_schema={"intent": '${intent.result}'})
flow.add_workflow_comp("travel", TravelComponent("travel"), inputs_schema={"intent": '${intent.result}'})
```

### 结束组件

将`End`结束组件注册到工作流中：

```python
from openjiuwen.core.component.end_comp import End

flow.set_end_comp("end", End(), inputs_schema={"eat": "${eat.intent}", "travel": "${travel.intent}"})
```

## 连接组件

通过调用 `flow.add_connection` 方法，可为工作流中的各个组件建立明确的连接关系，定义它们的执行顺序与逻辑流转：

```python
flow.add_connection("start", "intent")
flow.add_connection("eat", "end")
flow.add_connection("travel", "end")
```

## 运行工作流

基于以上搭建的工作流，触发`invoke`函数触发工作流执行：

```python
import asyncio
from openjiuwen.core.runtime.workflow import WorkflowRuntime

runtime = WorkflowRuntime()
output = asyncio.run(flow.invoke({"user_inputs": {"query": "去新疆"}}, runtime))
print(output.result)
```

选择`出行`分支：

```python
[travel] inputs = {'intent': '出行'}
```

获取工作流输出结果：

```python
{'output': {'travel': '出行'}}
```

# 完整示例代码

完整的示例参考如下所示：

```python
import asyncio
import random

from openjiuwen.core.component.base import WorkflowComponent
from openjiuwen.core.component.branch_router import BranchRouter
from openjiuwen.core.component.end_comp import End
from openjiuwen.core.component.start_comp import Start
from openjiuwen.core.context_engine.base import Context
from openjiuwen.core.graph.base import Graph
from openjiuwen.core.runtime.base import ComponentExecutable, Input, Output
from openjiuwen.core.runtime.runtime import Runtime
from openjiuwen.core.runtime.workflow import WorkflowRuntime
from openjiuwen.core.workflow.base import Workflow


class CustomIntentComponent(WorkflowComponent, ComponentExecutable):
    def __init__(self, default_intents):
        super().__init__()
        self._intents = default_intents
        self._router = BranchRouter()

    def add_component(self, graph: Graph, node_id: str, wait_for_all: bool = False) -> None:
        graph.add_node(node_id, self.to_executable(), wait_for_all=wait_for_all)
        graph.add_conditional_edges(node_id, self._router)

    def add_branch(self, condition: str, target: list[str], branch_id: str):
        self._router.add_branch(condition=condition, target=target, branch_id=branch_id)

    async def invoke(self, inputs: Input, runtime: Runtime, context: Context) -> Output:
        self._router.set_runtime(runtime)
        return {'result': self._intents[random.randint(0, len(self._intents) - 1)]}


class TravelComponent(WorkflowComponent, ComponentExecutable):
    def __init__(self, node_id):
        super().__init__()
        self.node_id = node_id

    async def invoke(self, inputs: Input, runtime: Runtime, context: Context) -> Output:
        print(f'[{self.node_id}] inputs = {inputs}')
        return inputs


class EatComponent(WorkflowComponent, ComponentExecutable):
    def __init__(self, node_id):
        super().__init__()
        self.node_id = node_id

    async def invoke(self, inputs: Input, runtime: Runtime, context: Context) -> Output:
        print(f'[{self.node_id}] inputs = {inputs}')
        return inputs


# 创建工作流
flow = Workflow()
flow.set_start_comp("start", Start(), inputs_schema={"query": "${user_inputs.query}"})
intent_component = CustomIntentComponent(["出行", "餐饮"])
intent_component.add_branch(condition="${intent.result} == '出行'", target=['travel'], branch_id='1')
intent_component.add_branch(condition="${intent.result} == '餐饮'", target=['eat'], branch_id='2')

flow.add_workflow_comp("intent", intent_component, inputs_schema={"query": "${start.query}"})
flow.add_workflow_comp("eat", EatComponent("eat"), inputs_schema={"intent": '${intent.result}'})
flow.add_workflow_comp("travel", TravelComponent("travel"), inputs_schema={"intent": '${intent.result}'})

flow.set_end_comp("end", End(), inputs_schema={"eat": "${eat.intent}", "travel": "${travel.intent}"})

flow.add_connection("start", "intent")
flow.add_connection("eat", "end")
flow.add_connection("travel", "end")


if __name__ == '__main__':
    runtime = WorkflowRuntime()
    output = asyncio.run(flow.invoke({"user_inputs": {"query": "去新疆"}}, runtime))
    print(output.result)
```
输出结果
```python
{'output': {'travel': '出行'}}
```