# 工作流组件

工作流组件是构成工作流的基本功能单元，各自承担特定业务逻辑或数据处理任务。组件之间通过数据交互与协同，支持异步处理、流式数据传输和动态编排，从而实现高效灵活的工作流运行。

以下从组件的分类、组件的能力类型以及组件的输入输出方面分别进行介绍。

## 组件的分类

组件分为预置组件和自定义组件。

- 预置组件：openJiuwen内置了两类组件，方便用户快速构建工作流：
  
  - 基础组件：用于流程控制，包括开始组件、结束组件、分支组件、循环组件、子工作流组件等，负责定义和管理工作流的执行逻辑。
  - 功能组件：用于提供业务功能支持，包括大模型组件、意图识别组件、提问器组件、插件组件等，开箱即用，尤其适合在Agent工作流中与大模型进行交互。
- 自定义组件：基于openJiuwen所提供的组件扩展能力，开发人员可便捷地开发自定义组件。

## 组件的能力类型

在工作流组件中，`invoke`、`stream`、`transform`和`collect`是四种核心能力，分别面向批处理和流处理的不同需求：

* `invoke`：对应枚举值`ComponentAbility.INVOKE`。表示将批数据一次性处理完毕，输出为批数据。适用于需要整体处理数据的场景，应用范围广泛。
* `stream`：对应枚举值`ComponentAbility.STREAM`。表示将批数据转为流数据，需逐条处理。适用于需要实时或分步处理数据的场景，如大模型的批量请求生成流式响应，或对数据进行逐条分析。
* `collect`：对应枚举值`ComponentAbility.COLLECT`。表示将流数据收集为批数据。适用于需要对流式输出进行汇总、聚合或最终结果生成的场景，如对大模型的流式输出进行收集、整理后返回最终结果。
* `transform`：对应枚举值`ComponentAbility.TRANSFORM`。表示对流数据进行格式转换或内容处理，输出为流数据。适用于需要对流式数据进行逐帧或逐条处理、格式转换、内容增强等场景，如对大模型的流式输出进行逐帧格式化后再输出。

具体组件能力类型实现请参考[组件能力类型实现](使用组件/组件支持的能力类型.md)。

## 组件的输入输出

组件支持流式与批数据两种形态的输入与输出。在数据处理链路中，在组件的输入端对原始数据进行格式化处理，供组件内使用。在组件输出端，对处理结果进行格式化，并分发给下游组件。详细请参考[定义组件的输入和输出格式](使用组件/定义组件输入输出格式.md)。

这样开箱即用的内置组件库，方便用户快速构建工作流，提升工作流的搭建效率，同时提供了组件扩展能力，方便用户丰富整个应用的功能生态。

# 连接

组件之间的连接关系，用于描述数据、控制信号或消息在组件间的流动路径。连接分为三种类型：一般连接、条件连接和流式连接。

* 一般连接：最基础的组件连接形式，用于描述组件之间的顺序依赖关系，即某个组件的执行依赖于前序组件的输出。
* 条件连接：在连接中引入条件判断逻辑，用于决定某个组件或分支是否被执行。例如，意图识别组件可以根据不同的识别结果选择进入不同的分支路径，从而实现动态分支控制。
* 流式连接：用于表达组件之间的流式数据传递关系。处于两端的组件通常称为生产者（Producer）和消费者（Consumer）。生产者组件产生的流式数据会通过流式连接实时传递给消费者组件，从而支持实时流式处理。在大模型输出Token数据流等场景中，流式连接被广泛应用。

这种多样化的连接机制，使工作流能够同时兼顾顺序化执行、条件化控制和实时化处理的需求，提升了业务流程的灵活性与表达能力。

# 工作流运行时传递

工作流运行时（WorkflowRuntime）是工作流执行的核心载体，负责在组件之间传递必要的数据与状态信息，确保整个工作流执行过程的一致性和完整性。

每次工作流被调用时，系统都会创建一个全新的运行时实例。该运行时封装了工作流执行所需的多类信息：

* 工作流配置：定义工作流整体的运行参数。
* 组件配置：记录各组件的个性化参数。
* 组件状态：保存组件在运行过程中的中间状态。
* 全局状态：支持在不同组件之间共享数据。

组件在运行过程中可以通过运行时进行数据读取与写入，从而实现与其他组件的协同。此外，运行时还提供了对框架功能模块的访问能力，例如流式输出等，进一步扩展了组件的能力边界。

通过这种设计，运行时不仅是数据与状态的集中管理中心，也是组件之间协作与扩展的基础设施。

# 工作流组合

不同的工作流之间可以通过工作流组件实现嵌套调用，其中被调用的工作流称为子工作流（SubWorkflow）。这种工作流的组合方式不仅打破了单一工作流的边界，还为复杂业务场景提供了更强的表达能力。

通过子工作流机制，用户可以：

* 分解复杂任务：将一个大型流程拆分为多个独立的子工作流，每个子工作流专注于处理特定的子任务，结构更加清晰。
* 提升复用性：常见的业务逻辑可以抽象为子工作流，在不同的主工作流中多次调用，避免重复实现。
* 增强灵活性：主工作流可以根据运行时的条件动态调用不同的子工作流，从而实现灵活的流程编排。
* 便于维护与扩展：子工作流作为相对独立的模块，可以单独开发、测试和迭代，降低维护成本。

这种基于子工作流的组合能力，使openJiuwen工作流不仅能够应对常规的直线型业务场景，还能够优雅地支持大规模、层次化、动态化的任务编排需求。
